```{r, libraries_question, include=FALSE}
library(tidyverse)
library(cowplot)
library(corrplot)
library(car)
```

# Analysis

<!-- 1 -->
## Determine if the response variable (price) has an acceptably normal distribution. Address test to discard serial correlation.

```{r q1_price_hist, echo = FALSE, fig.height = 3}

df <- df %>% mutate(price_log = log(price))

price_mean <- mean(df$price)
price_sd <- sd(df$price)

ggplot(df, aes(price)) +
    geom_histogram(aes(y = ..density..), bins = 30) +
    stat_function(
        fun = dnorm,
        args = list(mean = price_mean, sd = price_sd),
        color = "red"
    ) +
    annotate("text", max(df$price) * 3 / 4, 1e-5,
        color = "red",
        label = sprintf(
            "μ = %0.2f\nσ = %0.2f",
            price_mean,
            price_sd
        ),
    )
```

```{r q1_price_log_hist, echo = FALSE, fig.height = 3}

price_log_mean <- mean(df$price_log)
price_log_sd <- sd(df$price_log)

ggplot(df, aes(price_log)) +
    geom_histogram(aes(y = ..density..), bins = 30) +
    stat_function(
        fun = dnorm,
        args = list(mean = price_log_mean, sd = price_log_sd),
        color = "red"
    ) +
    annotate("text", 11, 0.75,
        color = "red",
        label = sprintf(
            "μ = %0.2f\nσ = %0.2f",
            price_log_mean,
            price_log_sd
        ),
    )
```

```{r q1_shapiro}
shapiro.test(df$price)
shapiro.test(log(df$price))
```

\Cref{fig:q1_qq_plots} shows the QQ plots.

```{r q1_qq_plots, echo=FALSE, fig.cap="QQ plots", fig.width=6}
plt_qq_price <- ggplot(df, aes(sample = price)) +
    stat_qq() +
    stat_qq_line(color = "red") +
    theme(aspect.ratio = 1) +
    labs(x = "Theoretical", y = "price")
plt_qq_log_price <- ggplot(df, aes(sample = log(price))) +
    stat_qq() +
    stat_qq_line(color = "red") +
    theme(aspect.ratio = 1) +
    labs(x = "Theoretical", y = "log(price)")

plot_grid(plt_qq_price, plt_qq_log_price, align = "hv", labels = "AUTO")
```

```{r q1_Kolmogorov-Smirnov}
df$price %>% ks.test("pnorm", mean = mean(.), sd = sd(.))
df$price_log %>% ks.test("pnorm", mean = mean(.), sd = sd(.))
```

```{r q1_durbinWatson, cache = TRUE}
durbinWatsonTest(lm(price ~ age, data = df))
durbinWatsonTest(lm(price ~ mpg, data = df))
durbinWatsonTest(lm(price ~ engineSize, data = df))
durbinWatsonTest(lm(price ~ year, data = df))
durbinWatsonTest(lm(price ~ mileage, data = df))
```

<!-- 2. --> \pagebreak
## Indicate by exploration of the data, which are apparently the variables most associated with the response variable (use only the indicated variables).

```{r q2_corrplot, fig.cap = "Correlation plot", fig.height = 3}
df %>%
    select(where(is.numeric), -price_log) %>%
    cor(use = "complete.obs", method = "spearman") %>%
    corrplot()
```

<!-- 3. --> \pagebreak
## Define a polytomic factor f.age for the covariate car age according to its quartiles, and argue if the average price depends on the level of age.  Statistically justify the answer.

```{r q3_bp}
df %>%
    ggplot(aes(x = aux_age, y = price, fill = aux_age)) +
    geom_boxplot()

anova <- aov(price ~ aux_age, data = df)
summary(anova)
TukeyHSD(anova)
```


<!-- 4. --> \pagebreak
## Calculate and interpret the anova model that explains car price according to the age factor and the fuel type.

```{r q4}
df %>%
    ggplot(aes(x = aux_age, y = price, fill = fuelType)) +
    geom_boxplot()

anova <- aov(price ~ aux_age * fuelType, data = df)
summary(anova)

group_by(df, aux_age, fuelType) %>%
    summarise(
        count = n(),
        mean = mean(price, na.rm = TRUE),
        sd = sd(price, na.rm = TRUE)
    )
```

<!-- 5. --> \pagebreak
## Do you think that the variability of the price depends on both factors? Does the relation between price and age factor depend on fuel type?

<!-- 6. --> \pagebreak
## Calculate the linear regression model that explains the price from the age: interpret the regression line and assess its quality.

<!-- 7. --> \pagebreak
## What is the percentage of the price variability that is explained by the age of the car?

<!-- 8. --> \pagebreak
## Do you think it is necessary to introduce a quadratic term in the equation that relates the price to its age?

<!-- 9. --> \pagebreak
## Are there any additional explanatory numeric variables needed to the car price? Study collinearity effects.

<!-- 10. --> \pagebreak
## After controlling by numerical variables, indicate whether the additive effect of the available factors on the price are statistically significant.

<!-- 11. --> \pagebreak
## Select the best model available so far. Interpret the equations that relate the explanatory variables to the answer (rate).

<!-- 12. --> \pagebreak
## Study the model that relates the logarithm of the price to the numerical variables.

<!-- 13. --> \pagebreak
## Once explanatory numerical variables are included in the model, are there any main effects from factors needed?

<!-- 14. --> \pagebreak
## Graphically assess the best model obtained so far.

<!-- 15. --> \pagebreak
## Assess the presence of outliers in the studentized residuals at a 99% confidence level. Indicate what those observations are.

<!-- 16. --> \pagebreak
## Study the presence of a priori influential data observations, indicating their number according to the criteria studied in class.

<!-- 17. --> \pagebreak
## Study the presence of a posteriori influential values, indicating the criteria studied in class and the actual atypical observations.

<!-- 18. --> \pagebreak
## Given a 5-year-old car, the rest of numerical variables on the mean and factors on the reference

<!-- 19. --> \pagebreak
## Summarize what you have learned by working with this interesting real dataset.
