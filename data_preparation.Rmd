```{r, libraries, include=FALSE}
library(tidyverse)
library(glue)
library(chemometrics)
library(mice)
```

# Data preparation

## Reading and initial preprocessing

Load and bind datasets into single one. Adding manufacturer column.

```{r read_data, echo = TRUE, message = FALSE}
df <- map2(# map through file and manufacturer names and read dataframes
    c("audi", "bmw", "merc", "vw"), # filename
    c("Audi", "BMW", "Mercedes", "Volkswagen"), # manufacturer
    function(filename, manufacturer) {
        read_csv(glue("./data/{filename}.csv"),
            col_types = "fiififidd"
        ) %>%
            mutate(manufacturer = as_factor(manufacturer)) # add column
    }
) %>%
    reduce(~ bind_rows(.x, .y)) # Bind rows into single dataframe
```

Get a sample of 5000:

```{r sample_data, echo = TRUE}
set.seed(19990428)
df <- df %>%
    slice_sample(n = 5000)
```

Add `manufacturer` to `model`, convert `year` and `engineSize` to factors and add
auxiliary factor variables for the numeric ones:

```{r aux_variables, echo = TRUE}
df <- df %>% mutate(
    model = as_factor(paste0(manufacturer, " - ", model)),
    age = 2020 - year,
    aux_price = cut_number(price / 1000, 4),
    aux_mileage = cut_number(mileage / 1000, 4),
    aux_mpg = cut_number(mpg, 4),
    aux_tax = cut_number(tax, 2),
    aux_age = cut_number(age, 4),
    year = as_factor(year),
    engineSize = as_factor(engineSize)
)
```

## Summary

```{r numeric_summary, echo = FALSE}
df %>%
    select(where(is.numeric)) %>%
    papeR::summarize_numeric() %>%
    kable(caption = "Summary of numeric variables", booktabs = TRUE) %>%
    kable_styling(latex_options = c("HOLD_position"), full_width = FALSE)
```

```{r factor_summary, echo = FALSE}
df %>%
    select(where(is.factor), -c(year, model, engineSize), -starts_with("aux_")) %>%
    papeR::summarize_factor() %>%
    kable(caption = "Summary of numeric variables", booktabs = TRUE) %>%
    kable_styling(latex_options = c("HOLD_position"), full_width = FALSE) %>%
    footnote(general = "year, model and engineSize omitted")
```

```{r aux_summary, echo = FALSE}
df %>%
    select(starts_with("aux_")) %>%
    papeR::summarize_factor() %>%
    kable(caption = "Summary of auxiliary factor variables", booktabs = TRUE) %>%
    kable_styling(latex_options = c("HOLD_position"), full_width = FALSE)
```

If we count the number of `NA` values per row, we find that there are no
explicit `NA` in the sample, as shown in \cref{tab:na}:

```{r na, echo = FALSE}
missings <- df %>%
    select(-starts_with("aux_"), -age) %>%
    summarise_all(~ sum(is.na(.))) %>%
    pivot_longer(everything(),
        names_to = "Variable",
        values_to = "Missing"
    )

zeros <- df %>%
    select(-starts_with("aux_"), -age) %>%
    summarise_all(~ sum(. == 0)) %>%
    pivot_longer(everything(),
        names_to = "Variable",
        values_to = "Zeros"
    )

left_join(missings, zeros, by = "Variable") %>%
    kable(caption = "Number of missing and zero values per row", booktabs = TRUE) %>%
    kable_styling(
        latex_options = c("HOLD_position"),
        full_width = FALSE
    )
```

## Outliers

There are no severe outliers

```{r severe_outliers}
iqr <- function(x) {
    tmp <- 3 * (quantile(x, 0.75, na.rm = TRUE) - quantile(x, 0.25, na.rm = TRUE))
    a <- quantile(x, 0.25, na.rm = TRUE) - tmp
    b <- quantile(x, 0.75, na.rm = TRUE) + tmp
    !dplyr::between(x, a, b)
}
soutliers <- df %>%
    mutate(across(where(is.numeric), iqr)) %>%
    summarise(across(where(is.numeric), sum)) %>%
    select(where(~ . != 0))

soutliers
```

```{r moutliers}
res_outliers <- df %>%
    select(where(is.numeric), -year, -tax) %>%
    Moutlier(quantile = 0.999, plot = FALSE)

df <- df %>%
    add_column(outlier = res_outliers$md > res_outliers$cutoff)
```

## Engine size and fuelType

There where only 3 electric cars in the original dataset before the sample,
in our sample, we have:

```{r}
df %>%
    group_by(fuelType) %>%
    summarise(n = n())
```

```{r}
df %>%
    ggplot(aes(engineSize, fuelType)) + geom_jitter()
```

```{r}
df %>%
    filter(engineSize == 0) %>%
    group_by(fuelType) %>%
    summarise(n = n())

df %>% group_by(model) %>% summarise(n = n()) %>% arrange(model) %>% view()

df[df$engineSize == 0, "engineSize"] <- NA

forcats::fct_inseq(df$model)

levels(df$model) <- sort(as.character(unique(df$model)))

```

# EDA

```{r na_ind}
df_sum <- df %>% transmute(
    zero_count = rowSums(across(
        c(
            where(is.numeric),
            -any_of(c("hour", "na_count", "zero_count"))
        ),
        ~ . == 0
    ), na.rm = TRUE),
    na_count = rowSums(across(everything(), is.na)),
)

df_sum %>%
    summarise(
        total_na = sum(na_count),
        nrows = sum(na_count != 0)
    )

df_sum
```

```{r na_var}
na_columns <- df %>%
    summarise_all(~ sum(is.na(.))) %>%
    rename_with(~ paste0(., "-NA"))
zero_columns <- df %>%
    summarise_all(~ sum(. == 0, na.rm = TRUE)) %>%
    rename_with(~ paste0(., "-Zeros"))

cbind(na_columns, zero_columns) %>%
    pivot_longer(everything(),
        names_to = c("variable", ".value"), names_sep = "-"
    ) %>%
    filter(!endsWith(variable, "_count") & !startsWith(variable, "aux_")) %>%
    kable(
        caption = "List of all NA or zeros by variable", booktabs = TRUE,
        col.names = c("Variable", "NA", "Zeros"),
        align = "lrr"
    ) %>%
    kable_styling(latex_options = c("HOLD_position")) %>%
    add_header_above(c(" " = 1, "Number of:" = 2))
```


# Imputation

We perform imputation with randomForest on the values marked with `NA`.

```{r}

library(missForest)

df_imp <- df %>%
    select(-model) %>%
    as.data.frame() %>%
    missForest()

oob_error <- df_imp$OOBerror

df_imp <- df_imp$ximp %>% as_tibble()


```

```{r save, include=FALSE}
source("io_checksum.R")
write_rds_w_checksum(df, "./data/dataset.rds")
```
